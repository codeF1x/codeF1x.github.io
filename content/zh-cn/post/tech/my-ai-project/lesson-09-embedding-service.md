+++
title = "ç¬¬ä¹è¯¾_æœåŠ¡ç«¯ Embedding ç”ŸæˆæœåŠ¡"
date = 2026-01-20T00:43:00+08:00
draft = false
categories = ["æŠ€æœ¯", "AI",'æ™ºèƒ½äº§å“æ¶æ„å¸ˆ']
+++

> **è¯¾ç¨‹ç›®æ ‡**ï¼šæ„å»ºç”Ÿäº§çº§çš„æ–‡æœ¬å‘é‡åŒ–æœåŠ¡ï¼Œæ”¯æŒå¤šæä¾›å•†ã€æ‰¹é‡å¤„ç†å’Œå®¹é”™æœºåˆ¶
>
> **æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼Œå¹¶åœ¨ RAG ç³»ç»Ÿä¸­é«˜æ•ˆä½¿ç”¨ï¼Ÿ

---

## ğŸ¯ æœ¬è¯¾è§£å†³çš„æ ¸å¿ƒé—®é¢˜

### é—®é¢˜èƒŒæ™¯

åœ¨ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. å°†ç”¨æˆ·çš„æ–‡æ¡£**åˆ‡åˆ†**ä¸ºå°å—ï¼ˆChunksï¼‰
2. å°†æ¯ä¸ª Chunk **è½¬æ¢ä¸ºå‘é‡**ï¼ˆEmbeddingï¼‰
3. å­˜å‚¨å‘é‡åˆ°æ•°æ®åº“ï¼Œç”¨äº**è¯­ä¹‰æœç´¢**

å‰é¢çš„è¯¾ç¨‹æˆ‘ä»¬å·²ç»å®ç°äº†æ–‡æ¡£åˆ†å—ï¼Œæœ¬è¯¾èšç„¦äº**ç¬¬2æ­¥ï¼šå‘é‡åŒ–**ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ Embeddingï¼Ÿ

```
ä¼ ç»Ÿæœç´¢ï¼šå…³é”®è¯åŒ¹é…
  "äººå·¥æ™ºèƒ½" â‰  "AI"  âŒ åŒ¹é…å¤±è´¥

è¯­ä¹‰æœç´¢ï¼šå‘é‡ç›¸ä¼¼åº¦
  "äººå·¥æ™ºèƒ½" â‰ˆ "AI"  âœ… è¯­ä¹‰ç›¸è¿‘ï¼ŒåŒ¹é…æˆåŠŸ
```

**Embedding å°†æ–‡æœ¬æ˜ å°„åˆ°é«˜ç»´å‘é‡ç©ºé—´ï¼Œè¯­ä¹‰ç›¸è¿‘çš„æ–‡æœ¬åœ¨ç©ºé—´ä¸­è·ç¦»ç›¸è¿‘ã€‚**

---

## ğŸ§  æ ¸å¿ƒæ¦‚å¿µå›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Embedding ç”Ÿæˆæµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   æ–‡æœ¬è¾“å…¥           API è°ƒç”¨              å‘é‡è¾“å‡º          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚                                                             â”‚
â”‚   "äººå·¥æ™ºèƒ½"   â”€â”€â–º  DeepSeek/OpenAI  â”€â”€â–º  [0.12, -0.45, ...]â”‚
â”‚                     Embedding API                           â”‚
â”‚                                                             â”‚
â”‚   ç»´åº¦: 1536                                                â”‚
â”‚   å«ä¹‰: æ–‡æœ¬çš„è¯­ä¹‰è¡¨ç¤º                                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer                             â”‚
â”‚         app/api/embeddings/generate/route.ts            â”‚
â”‚         â€¢ è¯·æ±‚éªŒè¯ (Zod)                                 â”‚
â”‚         â€¢ è·¯ç”±å¤„ç†                                       â”‚
â”‚         â€¢ å“åº”æ ¼å¼åŒ–                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Service Layer                          â”‚
â”‚              lib/embeddings/generate.ts                  â”‚
â”‚         â€¢ ä¸šåŠ¡é€»è¾‘                                       â”‚
â”‚         â€¢ é‡è¯•æœºåˆ¶                                       â”‚
â”‚         â€¢ æ‰¹é‡å¤„ç†                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Provider Layer                         â”‚
â”‚              Vercel AI SDK (embed/embedMany)            â”‚
â”‚         â€¢ DeepSeek                                       â”‚
â”‚         â€¢ OpenAI                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆè¿™æ ·åˆ†å±‚ï¼Ÿ

| å±‚çº§           | èŒè´£                | å¥½å¤„                     |
| -------------- | ------------------- | ------------------------ |
| API Layer      | å¤„ç† HTTP è¯·æ±‚/å“åº” | å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œä¾¿äºæµ‹è¯•     |
| Service Layer  | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘        | å¯å¤ç”¨ï¼Œå¯å•ç‹¬æµ‹è¯•       |
| Provider Layer | å°è£…å¤–éƒ¨ API        | åˆ‡æ¢æä¾›å•†æ— éœ€æ”¹ä¸šåŠ¡ä»£ç  |

---

## ğŸ”§ æ ¸å¿ƒä¼ªä»£ç 

### 1. å•ä¸ªæ–‡æœ¬å‘é‡åŒ–

```typescript
// ä¼ªä»£ç ï¼šå±•ç¤ºæ ¸å¿ƒé€»è¾‘
function generateEmbedding(text, options) {
  // 1. åˆå¹¶é»˜è®¤é…ç½®
  const config = { ...DEFAULT_OPTIONS, ...options };

  // 2. åˆ›å»º AI Provider
  const provider = createProvider(config.provider); // deepseek or openai

  // 3. é‡è¯•å¾ªç¯
  for (attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      // 4. è°ƒç”¨ Embedding API
      const { embedding, usage } = await embed({
        model: provider.textEmbeddingModel(modelName),
        value: text,
      });

      // 5. è¿”å›ç»“æœ
      return { embedding, dimensions: embedding.length, usage };
    } catch (error) {
      // 6. åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
      if (isRetryable(error) && attempt < maxRetries) {
        await delay(retryDelay * (attempt + 1)); // æŒ‡æ•°é€€é¿
        continue;
      }
      throw error;
    }
  }
}
```

### 2. æ‰¹é‡å¤„ç†ç­–ç•¥

```typescript
// ä¼ªä»£ç ï¼šå¤§æ‰¹é‡æ–‡æœ¬å¤„ç†
function generateEmbeddingsLargeBatch(texts, options) {
  const { batchSize } = options; // é»˜è®¤ 100
  const allEmbeddings = [];

  // åˆ†æ‰¹å¤„ç†
  for (i = 0; i < texts.length; i += batchSize) {
    const batch = texts.slice(i, i + batchSize);

    // è°ƒç”¨æ‰¹é‡ API
    const result = await embedMany({ values: batch });
    allEmbeddings.push(...result.embeddings);

    // æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…é™æµ
    if (hasMoreBatches) {
      await delay(100);
    }
  }

  return { embeddings: allEmbeddings, count: allEmbeddings.length };
}
```

### 3. é”™è¯¯é‡è¯•æœºåˆ¶

```typescript
// ä¼ªä»£ç ï¼šå¯é‡è¯•é”™è¯¯åˆ¤æ–­
function isRetryableError(error) {
  const RETRYABLE_CODES = [
    "ECONNRESET", // ç½‘ç»œé‡ç½®
    "ETIMEDOUT", // è¶…æ—¶
    "429", // é™æµ
    "500",
    "502",
    "503",
    "504", // æœåŠ¡å™¨é”™è¯¯
  ];

  return (
    RETRYABLE_CODES.includes(error.code) ||
    error.message.includes("timeout") ||
    error.message.includes("rate limit")
  );
}
```

---

## ğŸ›  å…³é”®æŠ€æœ¯ç‚¹

### 1. Vercel AI SDK é›†æˆ

**ä¸ºä»€ä¹ˆé€‰æ‹© Vercel AI SDKï¼Ÿ**

- ç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒå¤šä¸ªæä¾›å•†
- TypeScript åŸç”Ÿæ”¯æŒ
- å†…ç½®æµå¼å¤„ç†

```typescript
import { embed, embedMany } from "ai";
import { createDeepSeek } from "@ai-sdk/deepseek";
import { createOpenAI } from "@ai-sdk/openai";

// ç»Ÿä¸€è°ƒç”¨æ–¹å¼ï¼Œåˆ‡æ¢æä¾›å•†åªéœ€æ”¹ä¸€è¡Œ
const provider = createDeepSeek({ apiKey: process.env.DEEPSEEK_API_KEY });
const { embedding } = await embed({
  model: provider.textEmbeddingModel("deepseek-chat"),
  value: text,
});
```

### 2. æŒ‡æ•°é€€é¿é‡è¯•

**é—®é¢˜**ï¼šç½‘ç»œä¸ç¨³å®šæ—¶ï¼Œç«‹å³é‡è¯•å¯èƒ½åŠ å‰§é—®é¢˜

**è§£å†³**ï¼šæ¯æ¬¡é‡è¯•ç­‰å¾…æ›´é•¿æ—¶é—´

```typescript
// ç¬¬ 1 æ¬¡é‡è¯•: ç­‰å¾… 1000ms
// ç¬¬ 2 æ¬¡é‡è¯•: ç­‰å¾… 2000ms
// ç¬¬ 3 æ¬¡é‡è¯•: ç­‰å¾… 3000ms
await delay(retryDelay * (attempt + 1));
```

### 3. æ‰¹é‡å¤„ç†ä¼˜åŒ–

**é—®é¢˜**ï¼š1000 ä¸ªæ–‡æœ¬è°ƒç”¨ 1000 æ¬¡ API = æ…¢ + è´µ

**è§£å†³**ï¼šæ‰¹é‡è°ƒç”¨ + åˆ†æ‰¹å¤„ç†

```
å•æ¬¡è°ƒç”¨: 1000 requests Ã— 100ms = 100 ç§’
æ‰¹é‡è°ƒç”¨: 10 batches Ã— 200ms = 2 ç§’ (50x åŠ é€Ÿ!)
```

---

## âš ï¸ è¸©å‘è®°å½•

### å‘1ï¼šZod v4 API å˜æ›´

```typescript
// âŒ æ—§ç‰ˆå†™æ³•ï¼ˆZod v3ï¼‰
validation.error.errors;

// âœ… æ–°ç‰ˆå†™æ³•ï¼ˆZod v4ï¼‰
validation.error.issues;
```

**æ•™è®­**ï¼šå‡çº§ä¾èµ–åæ£€æŸ¥ breaking changes

### å‘2ï¼šTypeScript å…¨å±€ä½œç”¨åŸŸå†²çª

```typescript
// âŒ ä¸¤ä¸ªæ–‡ä»¶éƒ½å®šä¹‰äº† API_URL
// file1.ts
const API_URL = "http://localhost:3000/api/a";
// file2.ts
const API_URL = "http://localhost:3000/api/b"; // æŠ¥é”™ï¼

// âœ… ä½¿ç”¨å…·ä½“å‘½å
const EMBEDDING_API_URL = "http://localhost:3000/api/embeddings";
```

**æ•™è®­**ï¼šè„šæœ¬æ–‡ä»¶ä½¿ç”¨å…·ä½“å‘½åé¿å…å†²çª

### å‘3ï¼šESLint ç¦æ­¢ any

```typescript
// âŒ è¢«ç¦æ­¢
catch (error: any) { ... }

// âœ… ç±»å‹å®‰å…¨çš„å†™æ³•
catch (error: unknown) {
  const err = error as { message?: string; code?: string }
  const message = err.message || 'Unknown error'
}
```

**æ•™è®­**ï¼šç”¨ `unknown` + ç±»å‹æ–­è¨€æ›¿ä»£ `any`

---

## ğŸ“Š çŸ¥è¯†ç½‘ç»œ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   RAG ç³»ç»Ÿ   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ–‡æ¡£åˆ†å—  â”‚â”€â”€â”€â”€â–ºâ”‚ å‘é‡åŒ–   â”‚â”€â”€â”€â”€â–ºâ”‚ å‘é‡å­˜å‚¨ â”‚
   â”‚ (ç¬¬8è¯¾)  â”‚     â”‚ (æœ¬è¯¾)   â”‚     â”‚ (ä¸‹ä¸€è¯¾) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ‰¹é‡å¤„ç† â”‚     â”‚ é”™è¯¯é‡è¯• â”‚     â”‚ å¤šæä¾›å•† â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ è´¹æ›¼æ£€éªŒï¼šç”¨ä¸€å¥è¯è§£é‡Š

> **Embedding æœåŠ¡å°±åƒç¿»è¯‘å®˜**ï¼šæŠŠäººç±»è¯­è¨€"ç¿»è¯‘"æˆæœºå™¨èƒ½ç†è§£çš„æ•°å­—å‘é‡ï¼Œ
> è¿™æ ·æœºå™¨å°±èƒ½é€šè¿‡æ¯”è¾ƒæ•°å­—æ¥åˆ¤æ–­ä¸¤æ®µæ–‡å­—æ˜¯å¦æ„æ€ç›¸è¿‘ã€‚

---

## ğŸ“ å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹ 1ï¼šç†è§£å‘é‡ç›¸ä¼¼åº¦

```bash
# è¿è¡Œå¼€å‘æœåŠ¡å™¨
npm run dev

# ç”Ÿæˆä¸¤ä¸ªæ–‡æœ¬çš„å‘é‡
curl -X POST http://localhost:3000/api/embeddings/generate \
  -H "Content-Type: application/json" \
  -d '{"texts": ["äººå·¥æ™ºèƒ½", "AI", "ä»Šå¤©å¤©æ°”å¾ˆå¥½"]}'
```

**æ€è€ƒ**ï¼šå“ªä¸¤ä¸ªå‘é‡åº”è¯¥æ›´æ¥è¿‘ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

### ç»ƒä¹ 2ï¼šè§‚å¯Ÿæ‰¹é‡å¤„ç†

```typescript
// ä¿®æ”¹ batchSize è§‚å¯Ÿå·®å¼‚
const result = await generateEmbeddingsLargeBatch(texts, {
  batchSize: 10, // æ”¹æˆ 10, 50, 100 è§‚å¯Ÿ Token ä½¿ç”¨æƒ…å†µ
});
```

---

## âœ… æœ¬è¯¾æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ Embedding çš„ä½œç”¨ï¼ˆè¯­ä¹‰æœç´¢ï¼‰
- [ ] ç†è§£åˆ†å±‚æ¶æ„çš„å¥½å¤„
- [ ] æŒæ¡æ‰¹é‡å¤„ç†ç­–ç•¥
- [ ] æŒæ¡é”™è¯¯é‡è¯•æœºåˆ¶
- [ ] èƒ½è§£é‡ŠæŒ‡æ•°é€€é¿çš„åŸç†
- [ ] çŸ¥é“ Zod v4 çš„ API å˜åŒ–
- [ ] èƒ½ç”¨ `unknown` æ›¿ä»£ `any`

---

## ğŸ”— æ ¸å¿ƒä»£ç æ–‡ä»¶

| æ–‡ä»¶                                   | ä½œç”¨     | è¡Œæ•° |
| -------------------------------------- | -------- | ---- |
| `lib/embeddings/types.ts`              | ç±»å‹å®šä¹‰ | 50   |
| `lib/embeddings/generate.ts`           | æ ¸å¿ƒæœåŠ¡ | 265  |
| `app/api/embeddings/generate/route.ts` | API ç«¯ç‚¹ | 195  |
| `scripts/test-embedding-api.ts`        | æµ‹è¯•è„šæœ¬ | 147  |

---

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
- [DeepSeek API æ–‡æ¡£](https://platform.deepseek.com/docs)
- [å‘é‡æ•°æ®åº“åŸç†](https://www.pinecone.io/learn/vector-database/)

---

**ä¸‹ä¸€è¯¾é¢„å‘Š**ï¼šå‘é‡å­˜å‚¨ - å°† Embedding å†™å…¥ PostgreSQL + pgvector
